const Fe="modulepreload",Je=function(e){return"/"+e},ye={},j=function(t,n,r){let o=Promise.resolve();if(n&&n.length>0){let l=function(i){return Promise.all(i.map(d=>Promise.resolve(d).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),c=s?.nonce||s?.getAttribute("nonce");o=l(n.map(i=>{if(i=Je(i),i in ye)return;ye[i]=!0;const d=i.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${f}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":Fe,d||(u.as="script"),u.crossOrigin="",u.href=i,c&&u.setAttribute("nonce",c),document.head.appendChild(u),d)return new Promise((m,g)=>{u.addEventListener("load",m),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${i}`)))})}))}function a(s){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s}return o.then(s=>{for(const c of s||[])c.status==="rejected"&&a(c.reason);return t().catch(a)})};function Ve(){const e=document.getElementById("zflex-data");if(!e||!e.textContent)return console.warn("[Core/API] Tunnel de data #zflex-data est vide ou introuvable."),{};try{return JSON.parse(e.textContent)}catch(t){return console.error("[Core/API] Erreur de parsing du tunnel de data #zflex-data:",t),{}}}async function h(e,t){const r=Ve().apiEndpoints?.[e];if(!r)throw new Error(`Endpoint API pour "${e}" non trouv√©. V√©rifiez la configuration du builder.`);try{const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await o.json();if(!o.ok){const s=a.error||`Erreur ${o.status}`;throw new Error(s)}return a}catch(o){throw console.error(`[API] Erreur pour "${e}":`,o),new Error("La communication avec nos services a √©chou√©. Veuillez r√©essayer.")}}function Le(e,t={}){return h("createConv",{storeId:e,context:t})}function Ke(e,t,n,r){return h("stacy",{storeId:e,convId:t,message:n,contextDelta:r})}function he(e,t,n){return h("continueConv",{storeId:e,convId:t,functionCallResult:n})}function Wt(e,t){return h("createOrder",{...e,storeId:t})}function Gt(e,t){return h("getOrderDetails",{orderId:e,storeId:t})}function Yt(e,t,n,r,o){return h("initiatePayment",{orderId:e,storeId:t,paymentMethod:n,paymentPhone:r,transactionReference:o})}function Qt(e,t){return h("getOrderStatusApi",{orderId:e,storeId:t})}function Xt(e,t){return h("getProspectInfo",{storeId:e,prospectId:t})}function We(e,t){return h("trackEvent",{storeId:e,events:t})}let R=null;async function Ge(){if(R)return R;try{const e=await fetch("/api/search-index.json");if(!e.ok)throw new Error(`Erreur r√©seau: ${e.statusText}`);return R=await e.json(),R||[]}catch(e){return console.error("[Core/API] Impossible de charger l'index des produits:",e),[]}}const N=window.zflexEventBus||new EventTarget;window.zflexEventBus=N;const Te="zflex_cart";function x(){const e=localStorage.getItem(Te);return e?JSON.parse(e):[]}function G(e){localStorage.setItem(Te,JSON.stringify(e)),window.dispatchEvent(new CustomEvent("cartUpdated"))}function ce(e,t=1){const n=x(),r=n.find(o=>o.id===e.id);r?r.quantity+=t:n.push({...e,quantity:t}),G(n)}function ke(e,t){let n=x();const r=n.find(o=>o.id===e);r&&(t>0?r.quantity=t:n=n.filter(o=>o.id!==e),G(n))}function le(e){const t=x().filter(n=>n.id!==e);G(t)}function Ye(){G([])}function ve(){const e=document.getElementById("cart-count");if(!e)return;const n=x().reduce((r,o)=>r+o.quantity,0);e.textContent=String(n),e.style.display=n>0?"flex":"none",n>0&&(e.classList.add("updated"),setTimeout(()=>{e.classList.remove("updated")},300))}function _e(){if(!document.querySelector('[data-page-type="cart"]'))return;const t=document.getElementById("cart-items-list"),n=document.getElementById("cart-subtotal"),r=document.getElementById("cart-total"),o=document.getElementById("cart-empty-state"),a=document.getElementById("cart-content");if(!t||!n||!r||!o||!a){console.error("[Cart] Erreur critique: DOM manquant dans cart.njk.");return}const s=x(),c=document.getElementById("cart-item-template");if(!c){console.error("[Cart] Erreur critique: le template #cart-item-template est manquant.");return}if(s.length===0){o.classList.remove("hidden"),a.classList.add("hidden");return}o.classList.add("hidden"),a.classList.remove("hidden"),t.innerHTML="";let l={};s.forEach(i=>{const d=Number(i.price?.amount||0),f=i.price?.currency||"EUR",u=Number(i.quantity||1),m=c.content.cloneNode(!0),g=m.querySelector('[data-template-field="image"]');g&&(g.src=i.coverImage||"");const _=m.querySelector('[data-template-field="title"]');_&&(_.textContent=i.title||"Produit sans nom");const b=m.querySelector('[data-template-field="url"]');b&&(b.href=i.url||"#");const A=m.querySelector('[data-template-field="price"]');A&&(A.textContent=`${d.toFixed(2)} ${f}`);const O=m.querySelector('[data-template-field="quantity"]');O&&(O.value=String(u),O.addEventListener("change",()=>ke(i.id,parseInt(O.value,10))));const P=m.querySelector('[data-template-field="total"]');P&&(P.textContent=`${(d*u).toFixed(2)} ${f}`);const ge=m.querySelector('[data-template-field="remove-btn"]');ge&&ge.addEventListener("click",()=>le(i.id)),t.appendChild(m),l[f]||(l[f]=0),l[f]+=d*u}),n.innerHTML="",r.innerHTML="",Object.entries(l).forEach(([i,d])=>{const f=`${Number(d).toFixed(2)} ${i}`;n.innerHTML+=`<div>${f}</div>`,r.innerHTML+=`<div>${f}</div>`})}function Qe(){document.querySelector('[data-page-type="cart"]')&&(console.log("[Cart] Initialisation de la page panier..."),_e())}async function Xe(){document.querySelectorAll("#add-to-cart-btn").forEach(t=>{const n=t;n.dataset.listenerAttached||(n.addEventListener("click",async()=>{n.disabled=!0;try{const r=document.getElementById("zflex-data");if(!r)throw new Error("Erreur critique: Tunnel de data #zflex-data manquant.");const o=JSON.parse(r.textContent||"{}");if(!o?.product)throw new Error("Donn√©es du produit non trouv√©es dans le tunnel de data.");const s=(await Ge()).find(c=>c.id===o.product.id);if(s)ce(s),N.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"Ajout√© au panier !",message:`${s.title.trim()} a bien √©t√© ajout√©.`,variant:"success"}}));else throw new Error("Produit introuvable dans l'index de recherche.")}catch(r){console.error("Erreur lors de l'ajout au panier:",r),N.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"Erreur",message:r.message||"Impossible d'ajouter ce produit au panier.",variant:"error"}}))}finally{n.disabled=!1}}),n.dataset.listenerAttached="true")})}function Ze(){ve(),window.addEventListener("cartUpdated",()=>{ve(),_e()}),console.log("[Cart] Module global initialis√©.")}const et=Object.freeze(Object.defineProperty({__proto__:null,addItem:ce,clearCart:Ye,getCart:x,initAddToCartButton:Xe,initCartPage:Qe,initGlobalCart:Ze,removeItem:le,updateItemQuantity:ke},Symbol.toStringTag,{value:"Module"})),Ae="zflex_analytics_queue_v1",tt=1e4,nt=50,rt=3,ot=150;let p=[],Z=!1,ee=null,we=0;function Oe(){try{const e=document.getElementById("zflex-data");return!e||!e.textContent?{}:JSON.parse(e.textContent)}catch{return{}}}function at(){try{const e=localStorage.getItem(Ae);e&&(p=JSON.parse(e))}catch(e){console.warn("[Analytics] Load queue failed.",e),p=[]}}function de(){try{localStorage.setItem(Ae,JSON.stringify(p))}catch(e){console.warn("[Analytics] Persist queue failed.",e)}}function st(e,t={}){const n=Oe()||{},r=document.querySelector("main");return{type:e,payload:t,storeId:n.storeId||null,context:{pageType:r?.dataset.pageType||null,title:document.title,url:window.location.href},ts:new Date().toISOString(),version:n.zflex_version||null}}function w(e,t={}){if(!e)return;const n=st(e,t);p.push(n),de(),console.log(`[Analytics] Event Queued: ${e}`,t)}async function Pe(e,t=1){if(!e||e.length===0)return{ok:!0};try{const n=e[0].storeId;return n?(await We(n,e),{ok:!0}):{ok:!1,error:"Missing storeId"}}catch(n){return t<rt?(await new Promise(r=>setTimeout(r,1e3*t)),Pe(e,t+1)):{ok:!1,error:String(n)}}}async function ne(){if(!(Z||p.length===0)){Z=!0;try{const e=p.slice(0,nt),t=await Pe(e);t&&t.ok&&(p.splice(0,e.length),de())}finally{Z=!1}}}function it(){ee&&clearInterval(ee),ee=setInterval(ne,tt),document.addEventListener("visibilitychange",()=>document.visibilityState==="hidden"&&ne()),window.addEventListener("beforeunload",()=>{if(p.length!==0)try{const e=Oe(),t=e.apiEndpoints?.trackEvent;navigator.sendBeacon&&t&&(navigator.sendBeacon(t,JSON.stringify({storeId:e.storeId,events:p})),p=[],de())}catch(e){console.warn("[Analytics] Beacon failed.",e)}})}function ct(){const e={"stacy:message_sent":t=>w("send_stacy_message",{length:t.message.length}),"cart:item_added":t=>w("add_to_cart",t.item),"cart:item_removed":t=>w("remove_from_cart",t.item),"cart:cleared":()=>w("clear_cart"),"checkout:purchase_success":t=>w("purchase",t.order)};for(const[t,n]of Object.entries(e))N.addEventListener(t,r=>n(r.detail))}function lt(e){const t=e.getAttribute("data-analytics-type")||"",n=e.getAttribute("data-analytics-payload");let r={};if(n)try{r=JSON.parse(n)}catch(o){console.warn("[Analytics] √âchec parsing payload, attribut brut:",{payloadAttr:n,error:o})}return{type:t,payload:r}}function dt(){document.addEventListener("click",e=>{const t=Date.now();if(t-we<ot){e.stopImmediatePropagation();return}we=t;const r=e.target.closest("[data-analytics-type]");if(!r)return;const{type:o,payload:a}=lt(r);o&&w(o,a)},!0)}function ut(){at(),it(),dt(),ct(),console.log("[Analytics] Module V3.2 (The Final Cut) initialis√©.")}function Y({path:e,title:t,extra:n={}}={}){w("pageview",{url:e||window.location.href,title:t||document.title,...n})}function qe(e,t={}){w(e,t)}window.zflexAnalytics={track:qe,trackPageview:Y,flush:ne,getQueue:()=>p};const ft=Object.freeze(Object.defineProperty({__proto__:null,initAnalytics:ut,track:qe,trackPageview:Y},Symbol.toStringTag,{value:"Module"}));let re=!1;function De(){Me(),window.addEventListener("popstate",()=>ue());try{Y()}catch(e){console.warn("[Router] Le tracking de la page initiale a √©chou√©:",e)}console.log("[Router] Initialis√© en mode GATEKEEPER.")}function oe(e){if(re)return;const n=e.target.closest("a.zflex-link");if(!n||n.target==="_blank")return;const r=new URL(n.href);if(r.hash&&r.pathname===window.location.pathname){e.preventDefault();const a=document.querySelector(r.hash);a&&a.scrollIntoView({behavior:"smooth",block:"start"});return}if(r.origin!==window.location.origin)return;e.preventDefault(),e.preventDefault();const o=r.pathname+r.search+r.hash;Be(o)}function Me(){document.body.addEventListener("touchstart",()=>{re=!1},{passive:!0}),document.body.addEventListener("touchmove",()=>{re=!0},{passive:!0}),document.body.addEventListener("click",oe),document.body.addEventListener("touchend",oe)}function Be(e){e!==window.location.pathname&&(history.pushState({},"",e),ue())}async function ue(){const e=window.location.pathname;console.log(`[Router] Navigation d√©tect√©e vers : ${e}`);const t=e==="/"||e===""?"/content/home.html":`/content${e.replace(/\/$/,"")}.html`,n=document.getElementById("app-content"),r=document.getElementById("router-loader");if(!n){console.error("ERREUR CRITIQUE: Conteneur #app-content introuvable.");return}r&&r.classList.remove("hidden"),n.style.opacity="0.5",n.style.transition="opacity 0.3s ease-in-out";try{const o=await fetch(t);if(!o.ok){if(o.status===404){const c=await(await fetch("/content/404.html")).text();ae(c,"404 - Page non trouv√©e");return}throw new Error(`Erreur serveur: ${o.statusText}`)}const a=await o.text();ae(a)}catch(o){const a=o instanceof Error?o.message:String(o);console.error("Erreur de routage critique:",o),n.innerHTML=`
      <div class="text-center py-20">
        <h1 class="text-2xl font-bold">Erreur de chargement</h1>
        <p class="text-gray-600 mt-2">${a}</p>
        <button onclick="window.location.reload()" class="mt-4 bg-primary text-white font-bold py-2 px-4 rounded">Recharger la page</button>
      </div>
    `}finally{if(r&&r.classList.add("hidden"),document.body.contains(n)&&(n.style.opacity="1"),window.location.hash){const o=window.location.hash;setTimeout(()=>{const a=document.querySelector(o);a&&a.scrollIntoView({behavior:"smooth",block:"start"})},100)}else window.scrollTo(0,0)}}function ae(e,t=null){const n=document.getElementById("app-content"),r=document.getElementById("zflex-data"),s=new DOMParser().parseFromString(e,"text/html").querySelector("main");if(s&&r&&n){const c=s.querySelector(".zflex-fragment-data");c&&(r.textContent=c.textContent,c.remove()),document.title=t||s.dataset.pageTitle||document.title,n.innerHTML="",n.appendChild(s),window.dispatchEvent(new CustomEvent("zflex:page-loaded",{detail:{path:window.location.pathname}}));try{Y()}catch(l){console.warn("[Router] Le tracking de la nouvelle page a √©chou√©:",l)}}else console.error("Erreur critique: <main> ou #zflex-data manquant.")}const mt=Object.freeze(Object.defineProperty({__proto__:null,bindEventListeners:Me,handleLinkClick:oe,handleLocationChange:ue,initRouter:De,navigateTo:Be,updatePageContent:ae},Symbol.toStringTag,{value:"Module"}));let y=!1,E=[],se=null,z=null;const He=1440*60*1e3,k=e=>`stacy_conv_${e}`,Q=e=>`stacy_history_${e}`,pt=new Set(["searchProducts","manageCart","getContextDelta","redirectToVerifyPage"]);function $(){try{const t=document.getElementById("zflex-data")?.textContent;return t?JSON.parse(t):{}}catch(e){return console.error("[Stacy] Erreur de parsing des donn√©es de la page",e),{}}}async function Ne(){if(z)return z;try{const e=await fetch("/api/search-index.json");if(!e.ok)throw new Error(`R√©ponse r√©seau non OK: ${e.statusText}`);return z=await e.json(),z||[]}catch(e){return console.error("[Stacy] Impossible de charger l'index de recherche:",e),[]}}function v(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function gt(e){try{const t=String(e).trim();if(/^(https?:|mailto:)/i.test(t))return t}catch{}return"#"}function fe(e){let t=v(e);return t=t.replace(/```([\s\S]*?)```/g,(n,r)=>`<pre class="stacy-code"><code>${v(r)}</code></pre>`),t=t.replace(/`([^`]+)`/g,(n,r)=>`<code class="stacy-inline-code">${v(r)}</code>`),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(n,r,o)=>`<a href="${gt(o)}" target="_blank" rel="noopener noreferrer" class="zflex-link">${v(r)}</a>`),t=t.replace(/\*\*([^*]+)\*\*/g,(n,r)=>`<strong>${v(r)}</strong>`),t=t.replace(/\*([^*]+)\*/g,(n,r)=>`<em>${v(r)}</em>`),t=t.replace(/\r?\n/g,"<br>"),t}function me(e){try{let t=function(s){const c=Array.from(s.childNodes);for(const l of c)if(l.nodeType===Node.ELEMENT_NODE){const i=l;if(a.has(i.tagName)){if(i.tagName==="A"){const d=i.getAttribute("href")||"";/^(https?:|mailto:)/i.test(d.trim())?(i.setAttribute("target","_blank"),i.setAttribute("rel","noopener noreferrer")):i.removeAttribute("href")}else{const d=Array.from(i.attributes);for(const f of d)i.removeAttribute(f.name)}t(i)}else{const d=document.createDocumentFragment();for(;i.firstChild;)d.appendChild(i.firstChild);s.replaceChild(d,i),t(s);continue}}else l.nodeType!==Node.TEXT_NODE&&s.removeChild(l)};const o=new DOMParser().parseFromString(`<div>${e}</div>`,"text/html").body.firstChild;if(!o)return"";const a=new Set(["A","UL","OL","LI","STRONG","EM","CODE","PRE","BR","P"]);return t(o),o.innerHTML}catch(t){return console.warn("[Stacy] sanitizeHtml failed, falling back to escaped text",t),v(e)}}function X(e,t,n={rawHtml:!1}){const r=document.querySelector("[data-stacy-messages]");if(!r)return;const o=document.createElement("div");o.className="flex flex-col p-1 my-1 max-w-[85%] text-sm break-words";const a=document.createElement("div");a.className="p-2 rounded-lg";const s=document.createElement("div");s.className="text-xs mb-1 truncate";const c=typeof e.text=="string"?e.text:JSON.stringify(e.text??"");t==="user"?(o.style.alignSelf="flex-end",a.classList.add("bg-primary/20","self-end"),s.textContent="Vous",s.style.textAlign="right",a.textContent=c):(o.style.alignSelf="flex-start",s.textContent="Stacy",s.style.color="var(--text-muted-color)",a.classList.add("self-start"),a.style.backgroundColor="var(--chat-response-bg-color)",a.style.color="var(--text-color)",n.rawHtml?a.innerHTML=me(c):a.innerHTML=fe(c)),o.appendChild(s),o.appendChild(a),r.appendChild(o),r.scrollTop=r.scrollHeight}function $e(){const e=document.querySelector("[data-stacy-messages]");e&&(e.innerHTML="",E.forEach(t=>X(t,t.role,{rawHtml:!0})))}async function yt(){const e=$().storeId;if(!e)return;const t=localStorage.getItem(k(e)),n=t?JSON.parse(t):null;if(n&&Date.now()-n.createdAt<He){const r=localStorage.getItem(Q(n.convId));E=r?JSON.parse(r):[],$e()}else await ze(e)}function T(e){localStorage.setItem(Q(e),JSON.stringify(E))}function U(e,t){const n={role:t,text:e,ts:Date.now()};E.push(n),X(n,t,{rawHtml:!0})}function ht(){const e=document.querySelector("[data-stacy-messages]");if(!e)return null;const t=document.createElement("div");return t.className="p-2 my-1 rounded-lg max-w-[60%] self-start text-sm break-words stacy-typing",t.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>',e.appendChild(t),e.scrollTop=e.scrollHeight,t}function vt(e,t={rawHtml:!1}){const n=document.querySelector("[data-stacy-messages]");if(!n)return null;const r=document.createElement("div");r.className="flex flex-col p-1 my-1 max-w-[85%] text-sm break-words model-message-wrapper";const o=document.createElement("div");o.className="text-xs mb-1 truncate",o.textContent="Stacy",o.style.color="var(--muted-text-color)";const a=document.createElement("div");a.className="p-2 rounded-lg self-start model-message-bubble";const s=e;t.rawHtml?a.innerHTML=me(s):a.innerHTML=fe(s);const c=document.createElement("div");return c.className="stacy-partial-loader",c.style.marginTop="6px",c.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>',c.style.display="none",r.appendChild(o),r.appendChild(a),r.appendChild(c),n.appendChild(r),n.scrollTop=n.scrollHeight,{wrapper:r,bubble:a,loader:c}}function Ee(e){!e||!e.loader||(e.loader.style.display="",e.wrapper.scrollIntoView({behavior:"smooth",block:"end"}))}function L(e){!e||!e.loader||(e.loader.style.display="none")}function S(e,t,n={rawHtml:!1}){!e||!e.bubble||(n.rawHtml?e.bubble.innerHTML=me(t):e.bubble.innerHTML=fe(t),L(e))}async function be(e,t=12e3){let n;return Promise.race([e,new Promise((r,o)=>n=setTimeout(()=>o(new Error("timeout")),t))]).finally(()=>clearTimeout(n))}async function Re(e){const t=k(e);try{const n=localStorage.getItem(t);if(n){const o=JSON.parse(n);if(Date.now()-(o.createdAt||0)<=He)return o.convId}const r=await Le(e);if(!r?.convId)throw new Error("createConversation n'a pas retourn√© de convId");return localStorage.setItem(t,JSON.stringify({convId:r.convId,createdAt:Date.now()})),localStorage.removeItem(Q(r.convId)),r.convId}catch(n){throw console.error("[Stacy] Erreur getOrCreateConvId",n),n}}async function ze(e){try{const t=localStorage.getItem(k(e)),n=t?JSON.parse(t):null;n&&localStorage.removeItem(Q(n.convId)),localStorage.removeItem(k(e)),E=[],$e();const r=await Le(e);if(r?.convId){localStorage.setItem(k(e),JSON.stringify({convId:r.convId,createdAt:Date.now()}));const o=r.greeting||"Salut ! C'est Stacy, ton assistante shopping. Pr√™t(e) √† trouver des p√©pites ? ‚ú®";U(o,"model"),T(r.convId)}}catch(t){console.error("[Stacy] resetConversation error",t),X({text:"Impossible de r√©initialiser la conversation."},"model")}}async function wt(e){e.preventDefault();const n=e.target.querySelector("[data-stacy-input]");if(!n)return;const r=n.value.trim();if(!r)return;U(r,"user"),n.value="";const o=$().storeId;if(o){const a=await Re(o);T(a)}await Et(r)}async function Et(e){const t=document.querySelector("[data-stacy-input]");t&&(t.disabled=!0);const n=ht();try{const r=$().storeId;if(!r)throw new Error("storeId introuvable");const o=await Re(r),a=await Ke(r,o,e);if(n&&n.remove(),a.newConvId&&localStorage.setItem(k(r),JSON.stringify({convId:a.newConvId,createdAt:Date.now()})),a.functionCall){const l=vt("Un instant, je r√©fl√©chis... ü§î",{rawHtml:!1});if(Ee(l),a.needsUserInput){L(l);const d=a.answer||"J'ai besoin d'une information suppl√©mentaire.";if(S(l,d,{rawHtml:!1}),l&&l.wrapper){const f=l.wrapper,u=document.createElement("input");u.type="text",u.placeholder="Entrez le num√©ro de commande...",u.className="stacy-inline-input";const m=document.createElement("button");m.textContent="Envoyer",m.className="stacy-inline-btn";const g=document.createElement("div");g.style.marginTop="8px",g.appendChild(u),g.appendChild(m),f.appendChild(g),u.focus();const _=async()=>{const b=u.value.trim();if(b){g.remove(),Ee(l);try{const A=a.functionCall?.name||"unknown",P=(await he(r,o,{name:A,result:{orderId:b}}))?.answer??"D√©sol√©, erreur lors de la finalisation.";S(l,P,{rawHtml:!0}),E.push({role:"model",text:P}),T(o)}catch{L(l),S(l,"Erreur lors de l'envoi de l'information. R√©essaie.",{rawHtml:!1})}}};m.addEventListener("click",_),u.addEventListener("keydown",b=>{b.key==="Enter"&&_()})}return}const i=a.functionCall.name||"unknown";if(pt.has(i))try{const d=await be(bt(a.functionCall),12e3),f=d.result??d,m=(await be(he(r,o,{name:i,result:f}),2e4))?.answer??"D√©sol√©, erreur lors de la finalisation.";m.includes("__tool_result")?l?.wrapper.remove():(S(l,m,{rawHtml:!0}),E.push({role:"model",text:m})),T(o);return}catch{L(l),S(l,"Impossible d'ex√©cuter l'action c√¥t√© client.",{rawHtml:!1});return}if(a.answer){L(l),S(l,a.answer,{rawHtml:!0}),E.push({role:"model",text:a.answer}),T(o);return}L(l),S(l,"Action en attente...",{rawHtml:!1});return}const s=a?.answer??"D√©sol√©, une erreur est survenue.";U(s,"model"),T(o)}catch(r){n&&n.remove(),console.error("[Stacy] Erreur processStacyRequest",r),U("Oups, quelque chose s'est mal pass√©. Veuillez r√©essayer.","model")}finally{t&&(t.disabled=!1,y&&t.focus())}}async function bt(e){const t=e.name||e.functionName||e.fn||"unknown",n=e.args||e.arguments||e.params||{};switch(t){case"searchProducts":{const r=String(n.keywords||n.q||""),o=await St(r);return{success:!!o.success,action:"searchProducts",result:o}}case"manageCart":{const r=await Ct(n);return{success:!!r.success,action:"manageCart",result:r}}case"redirectToVerifyPage":{const r=await xt();return{success:!!r.success,action:"redirectToVerifyPage",result:r}}case"getContextDelta":return{success:!0,action:"getContextDelta",result:It()};default:return console.warn(`[Stacy] functionCall non g√©r√© c√¥t√© client: ${t}`),{success:!1,action:String(t),result:{displayText:`Action demand√©e inconnue c√¥t√© client: ${String(t)}`,reason:"unknown"}}}}async function St(e){const t=await Ne(),n=String(e||"").toLowerCase().split(" ").filter(o=>o),r=t.filter(o=>n.every(a=>o.title.toLowerCase().includes(a)));return r.length>0?{success:!0,products:r.slice(0,3).map(a=>({id:a.id,title:a.title,price:a.price,shortDescription:a.shortDescription,url:a.url})),displayText:`J'ai trouv√© ${r.length} produit(s).`}:{success:!1,displayText:`D√©sol√©, je n'ai trouv√© aucun produit pour "${v(String(e))}".`}}async function Ct(e){const t=e.action,n=e.productId,r=e.quantity||1;switch(t){case"add":{if(!n)return{success:!1,displayText:"Je ne sais pas quel produit ajouter."};const a=(await Ne()).find(s=>s.id===n);return a?(ce(a,r),{success:!0,displayText:`J'ai ajout√© ${r}x "${a.title}" √† votre panier.`}):{success:!1,displayText:`Je n'ai pas trouv√© le produit avec l'ID ${n}.`}}case"remove":return n?(le(n),{success:!0,displayText:"L'article a √©t√© retir√© de votre panier."}):{success:!1,displayText:"Je ne sais pas quel produit retirer."};case"list":default:{const o=x();return!o||o.length===0?{success:!0,cart:[],displayText:"Votre panier est actuellement vide."}:{success:!0,cart:o,displayText:`Votre panier contient ${o.length} article(s).`}}}}function It(){return{pageType:document.querySelector("#app-content main")?.dataset.pageType||"unknown",pageTitle:document.title,url:window.location.href,productContext:$().product||null}}async function xt(){if(se)try{return se.navigateTo("/verify/"),ie(),{success:!0,displayText:"[Action Syst√®me] Redirection vers /verify/ effectu√©e."}}catch(e){return console.warn("[Stacy] Router navigation failed",e),{success:!1,displayText:"[Action Syst√®me] Routeur non disponible."}}else return{success:!1,displayText:"[Action Syst√®me] Routeur non disponible."}}function ie(){const e=document.querySelector("[data-stacy-window]"),t=document.querySelector("[data-stacy-fab-button]");if(!e||!t)return;y=!y,e.classList.toggle("is-open",y),e.classList.toggle("hidden",!y),t.setAttribute("aria-expanded",String(y));const n=t.querySelector('[data-stacy-icon="chat"]'),r=t.querySelector('[data-stacy-icon="close"]');if(n&&r&&(n.style.opacity=y?"0":"1",r.style.opacity=y?"1":"0"),y){yt();const o=document.querySelector("[data-stacy-input]");o&&setTimeout(()=>o.focus(),50)}}function Lt(){const e=document.querySelector("[data-stacy-fab-button]");e&&e.addEventListener("click",ie);const t=document.querySelector("[data-stacy-form]");if(t){t.addEventListener("submit",wt);const r=t.querySelector("[data-stacy-input]");r&&r.addEventListener("keydown",o=>{const a=o;a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),t.requestSubmit())})}document.addEventListener("keydown",r=>{r.key==="Escape"&&y&&ie()});const n=document.querySelector("[data-stacy-delete]");n&&n.addEventListener("click",async()=>{try{const r=$().storeId;if(!r)throw new Error("storeId introuvable");await ze(r)}catch(r){console.error("[Stacy] delete conv failed",r),X({text:"Impossible de supprimer la conversation."},"model")}})}function Tt(e){document.querySelector("[data-stacy-fab]")&&(se=e,Lt(),console.log("[Stacy] Module V7.5 (Brain Upgrade) initialis√©."))}const kt=Object.freeze(Object.defineProperty({__proto__:null,initStacy:Tt},Symbol.toStringTag,{value:"Module"}));let D;function _t(){const e=document.getElementById("install-app-btn");e&&(console.log("[PWA] L'application est maintenant installable."),e.disabled=!1,e.classList.remove("opacity-50","cursor-not-allowed"),e.addEventListener("click",At,{once:!0}))}function je(){const e=document.getElementById("install-app-btn"),t=document.getElementById("app-installed-message");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))}async function At(){if(!D)return;D.prompt();const{outcome:e}=await D.userChoice;e==="accepted"?(console.log("[PWA] L'utilisateur a accept√© l'installation."),je()):console.log("[PWA] L'utilisateur a refus√© l'installation."),D=null}function Ot(){window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone?(console.log("[PWA] D√©tect√© comme une application install√©e."),je()):window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),D=e,_t()}),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(()=>console.log("[PWA] Service Worker OK.")).catch(e=>console.error("[PWA] Service Worker KO:",e))}const Pt=Object.freeze(Object.defineProperty({__proto__:null,initPwa:Ot},Symbol.toStringTag,{value:"Module"}));let I=null,te=null,F=null,M=null,B=null,C=null,J=null,V=null,K=null,W=null,H=null;function pe(){I&&(I.classList.add("hidden"),W=null,H=null)}function qt(){if(typeof W=="function")try{W()}catch(e){console.error("[Dialog] Erreur dans onConfirm:",e)}pe()}function Dt(){if(typeof H=="function")try{H&&H()}catch(e){console.error("[Dialog] Erreur dans onCancel:",e)}pe()}function Ue(e,t,n={}){if(!I){alert(`${e}

${t}`),n.onConfirm&&n.onConfirm();return}J?.classList.add("hidden"),V?.classList.add("hidden"),K?.classList.add("hidden"),n.variant==="success"?J?.classList.remove("hidden"):n.variant==="error"?V?.classList.remove("hidden"):K?.classList.remove("hidden"),F&&(F.textContent=e),M&&(n.messageHtml?M.innerHTML=n.messageHtml:M.textContent=t||""),B&&(B.textContent=n.confirmText||"OK"),C&&(n.cancelText?(C.classList.remove("hidden"),C.textContent=n.cancelText):C.classList.add("hidden")),W=typeof n.onConfirm=="function"?n.onConfirm:null,H=typeof n.onCancel=="function"?n.onCancel:null,I.classList.remove("hidden")}function Mt(){if(I=document.getElementById("zflex-dialog"),!!I){if(te=document.getElementById("dialog-overlay"),F=document.getElementById("dialog-title"),M=document.getElementById("dialog-message"),B=document.getElementById("dialog-confirm-btn"),C=document.getElementById("dialog-cancel-btn"),J=document.getElementById("dialog-icon-success"),V=document.getElementById("dialog-icon-error"),K=document.getElementById("dialog-icon-info"),!te||!F||!M||!B||!J||!V||!K||!C){console.error("[Dialog] Un ou plusieurs √©l√©ments internes du dialog sont manquants. V√©rifie les IDs."),I=null;return}te.addEventListener("click",pe),B.addEventListener("click",qt),C.addEventListener("click",Dt),N.addEventListener("dialog:show",e=>{const t=e.detail||{},{title:n,message:r,variant:o}=t,a={variant:o,onConfirm:t.onConfirm,onCancel:t.onCancel,confirmText:t.confirmText,cancelText:t.cancelText,messageHtml:t.messageHtml};Ue(n,r,a)}),console.log("[Dialog] Module initialis√© et pr√™t (callbacks & HTML).")}}const Bt=Object.freeze(Object.defineProperty({__proto__:null,initDialog:Mt,showDialog:Ue},Symbol.toStringTag,{value:"Module"}));function Ht(){const e={threshold:.1,rootMargin:"0px 0px -50px 0px"},t=new IntersectionObserver(r=>{r.forEach(o=>{o.isIntersecting&&(o.target.classList.add("is-visible"),t.unobserve(o.target))})},e),n=document.querySelectorAll(".reveal-on-scroll");n.forEach(r=>t.observe(r)),console.log(`[FOCUS] Observer connected to ${n.length} elements.`)}function Zt(e=document.body){const t={threshold:.1,rootMargin:"0px 0px -50px 0px"},n=new IntersectionObserver(o=>{o.forEach(a=>{a.isIntersecting&&(a.target.classList.add("is-visible"),n.unobserve(a.target))})},t),r=e.querySelectorAll(".reveal-on-scroll");r.forEach(o=>n.observe(o)),console.log(`[FOCUS] Observer refreshed for ${r.length} elements in container.`)}function Nt(){const e=document.getElementById("sticky-cta");if(!e)return;const t=document.querySelector(".hero-section"),n=t?t.clientHeight:window.innerHeight;window.addEventListener("scroll",()=>{window.scrollY>n*.8?(e.classList.remove("hidden"),e.classList.add("visible")):e.classList.remove("visible")})}function $t(){const e=document.getElementById("progress-bar");e&&window.addEventListener("scroll",()=>{const t=document.body.scrollTop||document.documentElement.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,r=t/n*100;e.style.width=r+"%"})}const Rt=()=>{const e=document.getElementById("mobile-menu-toggle"),t=document.getElementById("mobile-menu"),n=document.querySelectorAll(".mobile-link");!e||!t||(e.addEventListener("click",()=>{t.classList.toggle("hidden")}),n.forEach(r=>{r.addEventListener("click",()=>{t.classList.add("hidden")})}),document.addEventListener("click",r=>{const o=r.target;!t.contains(o)&&!e.contains(o)&&!t.classList.contains("hidden")&&t.classList.add("hidden")}))},{initGlobalCart:zt,initCartPage:jt,initAddToCartButton:Ut}=et,{initStacy:Ft}=kt,{initDialog:Jt}=Bt,{initPwa:Vt}=Pt,{initAnalytics:Kt}=ft;let Se=!1,q=null;const Ce={"product-detail":async()=>(Ut(),{destroy:()=>console.log("[App] Cleanup: product-detail")}),catalog:async()=>{const{initCatalog:e}=await j(async()=>{const{initCatalog:t}=await import("./catalog-CwnX3g8W.js");return{initCatalog:t}},[]);return e(),{destroy:()=>console.log("[App] Cleanup: catalog")}},cart:async()=>(jt(),{destroy:()=>console.log("[App] Cleanup: cart")}),checkout:async()=>{const{initCheckout:e}=await j(async()=>{const{initCheckout:t}=await import("./checkout-DYPO5eYl.js");return{initCheckout:t}},[]);return e(),{destroy:()=>console.log("[App] Cleanup: checkout")}},"order-success":async()=>{const{initOrderSuccess:e}=await j(async()=>{const{initOrderSuccess:t}=await import("./order-success-CvISDv6C.js");return{initOrderSuccess:t}},[]);return e(),{destroy:()=>console.log("[App] Cleanup: order-success")}},unknown:async()=>({destroy:()=>{}})};async function Ie(){q&&typeof q.destroy=="function"&&q.destroy();const t=document.querySelector("#app-content main")?.dataset?.pageType||"unknown";console.log(`[App] Hydrating page scripts for: "${t}"`),Ht();const n=Ce[t]||Ce.unknown;try{q=await n()}catch(r){console.error(`[App] Error loading module for "${t}":`,r),q=null}}function xe(){if(Se)return;console.log("[FOCUS] Initializing Architecture...");const e=new URLSearchParams(window.location.search).get("preview")==="true";e&&(console.log("[App] Mode Preview activ√© - D√©sactivation des interactions"),document.body.style.pointerEvents="none",document.body.style.cursor="not-allowed",j(async()=>{const{initPreviewMode:t}=await import("./preview-ebBAQf-n.js");return{initPreviewMode:t}},[]).then(({initPreviewMode:t})=>{t()}));try{if(!window.firebase||!window.firebase.initializeApp)throw new Error("SDK Firebase absent. V√©rifie _head.njk.");const t=document.getElementById("firebase-config-data");if(!t)throw new Error("Firebase config island manquante.");const n=JSON.parse(t.textContent||"{}");if(!n.apiKey)throw new Error("Firebase apiKey manquante.");window.firebase.initializeApp(n),console.log("[Firebase] Initialisation r√©ussie.")}catch(t){if(console.error("[Firebase] √âCHEC CRITIQUE :",t),!e)return}e||(zt(),Ft(mt),Jt(),Vt(),Kt(),$t(),Nt(),Rt(),De(),window.addEventListener("zflex:page-loaded",(t=>{console.log(`[App] Navigation detected: ${t.detail?.path}`),Ie()}))),Ie(),Se=!0,console.log("%c [FOCUS] Ready. Status: Optimized. ","color: #00ff00; font-weight: bold; background: #000; padding: 4px;")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",xe,{once:!0}):xe();export{j as _,Xt as a,Qt as b,Wt as c,Ye as d,N as e,Gt as f,x as g,Yt as i,Be as n,Zt as r,Ue as s};
