import{g as R,a as _,e as j,c as F,i as G,b as N,d as J,n as K}from"./app-DmkVWR2K.js";function V(){try{const e=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!e||!e.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(e.textContent)}catch(e){return console.error("[Checkout] Erreur de parsing du tunnel de data:",e),{}}}function Q(){return Math.random().toString(36).slice(2,9)}function W(e){return`${e}-${Date.now()}-${Q()}`}function D(e){return e==null?"":String(e)}function X(e){if(e){if(typeof e.transactionStatus=="string")return e.transactionStatus;if(e.result&&typeof e.result.transactionStatus=="string")return e.result.transactionStatus;if(e.data&&typeof e.data.transactionStatus=="string")return e.data.transactionStatus;if(typeof e.status=="string")return e.status}}function Y(e){if(e)return e.error||e.message||e.result?.error||e.result?.message||e.data?.error}function Z(e){const t=document.getElementById("summary-items-list"),u=document.getElementById("summary-subtotal"),w=document.getElementById("summary-total");if(!t||!u||!w)return;if(!e||e.length===0){t.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>',u.innerHTML="",w.innerHTML="";return}t.innerHTML="";const E={};e.forEach(m=>{const x=document.createElement("div");x.className="flex justify-between items-center text-sm mb-4";const L=m.coverImage||"https://via.placeholder.com/64?text=No+Image",h=m.title||"Produit",y=m.price?.amount||0,I=m.price?.currency||"EUR",f=m.quantity||1;x.innerHTML=`
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 flex-shrink-0 border rounded overflow-hidden" style="border-color: var(--card-border-color);">
          <img src="${L}" alt="${h}" class="w-full h-full object-cover">
        </div>
        <div>
          <div class="font-medium" style="color: var(--text-color);">
            <span class="font-bold text-xs px-1 py-0.5 rounded mr-1" style="background-color: var(--card-bg-color);">${f}x</span> 
            ${h}
          </div>
        </div>
      </div>
      <span class="font-medium whitespace-nowrap ml-2" style="color: var(--text-color);">
        ${(y*f).toFixed(2)} ${I}
      </span>
    `,t.appendChild(x),E[I]||(E[I]=0),E[I]+=y*f}),u.innerHTML="",w.innerHTML="",Object.entries(E).forEach(([m,x])=>{const L=`${Number(x).toFixed(2)} ${m}`;u.innerHTML+=`<div style="color: var(--text-color);">${L}</div>`,w.innerHTML+=`<div style="color: var(--text-color);">${L}</div>`})}function te(){const e=document.getElementById("checkout-form");if(!e)return;const t=document.getElementById("checkout-error");let u=null;const w=async o=>{const c=localStorage.getItem("zflex_prospectId");if(!(!c||!o))try{const r=await _(o,c);r.success&&r.data&&j.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",messageHtml:`
                <div style="display:flex;gap:12px;align-items:center">
                  <div style="width:56px;height:56px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:600;color:#111">${(r.data.name||"U").charAt(0)}</div>
                  <div>
                    <div>Nom: <strong>${D(r.data.name)}</strong></div>
                    <div>Tél: <strong>${D(r.data.phone)}</strong></div>
                    <div style="color:#6b7280">${D(r.data.address)}</div>
                  </div>
                </div>
              `,confirmText:"Oui, utiliser",cancelText:"Non, merci",variant:"info",onConfirm:()=>{const n=e.elements;n.name&&(n.name.value=r.data?.name||""),n.email&&(n.email.value=r.data?.email||""),n.phone&&(n.phone.value=r.data?.phone||""),n.address&&(n.address.value=r.data?.address||""),n.notes&&(n.notes.value=r.data?.notes||"")}}}))}catch(r){console.warn("Impossible de récupérer les infos du prospect/client:",r?.message||r),String(r?.message||"").includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},E=V().storeId;if(!E){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const o=document.querySelector(".lg\\:col-span-3");o&&(o.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}w(E);const m=R()||[];Z(m);const x=document.getElementById("step-address"),L=document.getElementById("step-payment"),h=document.getElementById("continue-to-payment-btn"),y=document.getElementById("progress-bar"),I=document.getElementById("checkout-title"),f=document.getElementById("submit-order-btn"),S=document.getElementById("payment-phone"),q=document.getElementById("operator-logo-container"),T=document.getElementById("selected-payment-method"),$=document.getElementById("payment-instructions"),p=document.getElementById("use-geolocation-btn"),z=document.getElementById("address");if(!h||!f||!t){console.error("[Checkout] Éléments DOM critiques manquants (boutons ou erreur).");return}const P=async(o,c,r=null)=>{const n=(o||"").toUpperCase(),s=f.querySelector(".btn-spinner"),a=f.querySelector(".btn-text");if(n==="SUCCESS"||n==="SUCCEEDED"||n==="COMPLETED"){s&&s.classList.add("hidden"),a&&(a.textContent="Paiement réussi ! Redirection..."),y&&(y.style.width="100%"),setTimeout(()=>{J();try{K(`/order-success/?id=${encodeURIComponent(u||"")}`)}catch{window.location.href=`/order-success/?id=${encodeURIComponent(u||"")}`}},900);return}if(n==="PENDING"){s&&s.classList.add("hidden"),f.disabled=!1,a&&(a.textContent="Statut: En attente de confirmation"),y&&(y.style.width="95%"),t.textContent=c||"La transaction est en attente. Veuillez confirmer sur votre téléphone.",t.classList.remove("hidden");return}s&&s.classList.add("hidden"),f.disabled=!1,a&&(a.textContent="Confirmer et Payer"),t.textContent=c||"Le paiement a échoué. Veuillez réessayer ou contacter le support.",t.classList.remove("hidden")},O=async()=>{t.classList.add("hidden");const o=e.elements,c=o.name.value.trim(),r=o.email.value.trim(),n=o.phone.value.trim(),s=o.address.value.trim();if(!c||!r||!n||!s){t.textContent="Veuillez remplir tous les champs requis.",t.classList.remove("hidden");return}h.disabled=!0,h.textContent="Enregistrement...";try{const a={name:c,email:r,phone:n,address:s,notes:o.notes?.value.trim()||""},g=m.reduce((v,d)=>v+d.price.amount*d.quantity,0),C={customer:a,items:m,total:g,currency:m[0]?.price.currency||"EUR"},i=await F(C,E);if(!i.success||!i.orderId)throw new Error(i.error||"La création de la pré-commande a échoué.");u=i.orderId,i.readableId&&localStorage.setItem(`zflex_readable_${u}`,i.readableId),i.prospectId&&localStorage.setItem("zflex_prospectId",i.prospectId),x&&x.classList.add("hidden"),L&&L.classList.remove("hidden"),y&&(y.style.width="60%"),I&&(I.textContent="Étape 2: Paiement")}catch(a){t.textContent=a.message||"Une erreur est survenue.",t.classList.remove("hidden"),h.disabled=!1,h.textContent="Continuer vers le paiement"}},A=async o=>{if(o.preventDefault(),t.classList.add("hidden"),!u){t.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",t.classList.remove("hidden");return}const c=T?.value,n=(S?.value||"").replace(/\D/g,"");if(!c||!n||n.length<9){t.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",t.classList.remove("hidden");return}f.disabled=!0;const s=f.querySelector(".btn-text"),a=f.querySelector(".btn-spinner");s&&(s.textContent="Initiation du paiement..."),a&&a.classList.remove("hidden");const g=`zflex_txref_${u}`;let C=localStorage.getItem(g);if(!C){C=W(u);try{localStorage.setItem(g,C)}catch{}}try{const i=V().storeId;if(!i)throw new Error("Erreur de configuration : ID du store manquant.");const v=await G(u,i,c,`+243${n}`,C),d=Y(v),M=X(v);if(d)if(String(d).toLowerCase().includes("transactionreference already exists")||String(d).toLowerCase().includes("transactionreference")&&String(d).toLowerCase().includes("exists"))try{const b=await N(u,i),l=b,k=l.transactionStatus||l.result?.transactionStatus||l.status||l.data?.transactionStatus||l.statusText||(l.success?l.result?.transactionStatus:void 0),B=l.message||l.result?.message||l.error||"La transaction existe déjà. Nous vérifions son statut.";await P(k,B,b);return}catch{t.textContent="Impossible de vérifier le statut de la transaction existante.",t.classList.remove("hidden"),a&&a.classList.add("hidden"),f.disabled=!1,s&&(s.textContent="Confirmer et Payer");return}else throw new Error(String(d));if(M)if(M.toUpperCase()==="PENDING"){await P("PENDING","Veuillez confirmer sur votre téléphone...");return}else if(["SUCCESS","SUCCEEDED","COMPLETED"].includes(M.toUpperCase())){await P("SUCCESS","Paiement confirmé.");return}else throw new Error(`Statut de transaction inattendu: ${M}`);try{const b=await N(u,i),l=b,k=l.transactionStatus||l.result?.transactionStatus||l.status||l.data?.transactionStatus,B=l.message||l.result?.message||"";await P(k,B,b)}catch{throw new Error("Statut de transaction inattendu.")}}catch(i){const v=i?.message||String(i);let d="Le lancement du paiement a échoué.";v.includes("transactionReference already exists")?d="Une tentative existe déjà. Vérification...":v.includes("transactionReference")?d="Erreur de référence. Rafraîchissez la page.":v.includes("aucun opérateur")||v.toLowerCase().includes("operator")?d="Opérateur non supporté pour ce numéro.":d=v,t.textContent=d,t.classList.remove("hidden"),a&&a.classList.add("hidden"),f.disabled=!1,s&&(s.textContent="Confirmer et Payer")}},U=()=>{if(!S)return;const c=(S.value||"").replace(/\D/g,"").substring(0,2),r=["81","82","83"],n=["80","84","85","89"],s=["97","99"],a=["90"];let g="";if(r.includes(c)&&(g="MPESA"),n.includes(c)&&(g="ORANGE"),s.includes(c)&&(g="AIRTEL"),a.includes(c)&&(g="AFRICELL"),q&&(q.innerHTML=""),g&&T&&$){T.value=g;const C=m.reduce((v,d)=>v+d.price.amount*d.quantity,0).toFixed(2),i=m[0]?.price.currency||"USD";$.innerHTML=`<p>Opérateur <strong>${g}</strong> détecté. Vous recevrez une notification de <strong>MaishaPay</strong> pour valider le paiement de <strong>${C} ${i}</strong>.</p>`}else T&&$&&(T.value="",$.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>")},H=()=>{if(!navigator.geolocation){t.textContent="La géolocalisation n'est pas supportée.",t.classList.remove("hidden");return}p&&(p.disabled=!0,p.classList.add("animate-pulse"),navigator.geolocation.getCurrentPosition(async o=>{const{latitude:c,longitude:r}=o.coords;try{const s=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${c}&lon=${r}`)).json();if(s&&s.display_name&&z)z.value=s.display_name;else throw new Error("Adresse non trouvée.")}catch{t.textContent="Impossible de récupérer l'adresse.",t.classList.remove("hidden")}finally{p&&(p.disabled=!1,p.classList.remove("animate-pulse"))}},o=>{console.warn("[Checkout] Erreur Géoloc:",o),t.textContent="Erreur de géolocalisation ("+o.code+") - TIMEOUT: 20s",t.classList.remove("hidden"),p&&(p.disabled=!1,p.classList.remove("animate-pulse"))},{timeout:2e4,enableHighAccuracy:!0,maximumAge:0}))};return h.addEventListener("click",O),S&&S.addEventListener("input",U),p&&p.addEventListener("click",H),e.addEventListener("submit",A),console.log("[Checkout] Module V13.0 initialisé."),{destroy:()=>{h.removeEventListener("click",O),S&&S.removeEventListener("input",U),p&&p.removeEventListener("click",H),e.removeEventListener("submit",A),console.log("[Checkout] Module détruit.")}}}export{te as initCheckout};
